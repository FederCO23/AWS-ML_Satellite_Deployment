<!DOCTYPE html>
<html lang="en">
<head>
    <title>Solar Plant Detection through Satellite Imagery (Sentinel-2)</title>
<script>
    async function startWorkflow() {
        let lat = parseFloat(document.getElementById("latitude").value);
        let lon = parseFloat(document.getElementById("longitude").value);
        let ns = parseInt(document.getElementById("ns_distance").value);
        let we = parseInt(document.getElementById("we_distance").value);

        // Brazil Data Cube Coverage Bounds
        const LAT_MIN = -34.6755645921443;
        const LAT_MAX = 5.76326400552693;
        const LON_MIN = -74.871069;
        const LON_MAX = -28.0062080416543;

        if (isNaN(lat) || isNaN(lon)) {
            alert("Please enter valid numerical values for latitude and longitude.");
            return;
        }

        if (lat < LAT_MIN || lat > LAT_MAX || lon < LON_MIN || lon > LON_MAX) {
            alert("Zone out of Brazil Data Cube bounds.");
            return;
        }

        let response = await fetch("https://j4zkohkobg.execute-api.us-east-1.amazonaws.com/dev/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                center_point: [lat, lon],
                ns_distance_km: ns, 
                we_distance_km: we
            })
        });

        let data = await response.json();
        logStatus("Starting analysis...");
        
        if (data.executionArn) {
            logStatus(`Workflow started! Tracking execution: ${data.executionArn}`);
            checkStatus(data.executionArn);
        } else {
            logStatus(`Error: ${data.error}`);
        }
    }

let lastLoggedStep = null;  // Store last logged step to avoid duplicates



async function checkStatus(executionArn) {
    try {
        let response = await fetch(`https://j4zkohkobg.execute-api.us-east-1.amazonaws.com/dev/status?executionArn=${executionArn}`, {
            method: "GET",
            headers: { "Content-Type": "application/json" }
        });

        if (!response.ok) {
            throw new Error(`API Error: ${response.status} - ${response.statusText}`);
        }

        let data = await response.json();

        // Log only if the step has changed
        if (data.current_step !== lastLoggedStep) {
            logStatus(`Status: ${data.status} - Step: ${data.current_step || "Unknown"}`);
            lastLoggedStep = data.current_step;
        }

        // If the transaction_id is available, fetch overlay and statistics
        if (data.transaction_id) {
            displayOverlay(data.transaction_id);
            fetchReport(data.transaction_id);  // FIXED: Pass `transaction_id` instead of `executionArn`
        }

        // Continue polling if the process is not complete
        if (data.status !== "SUCCEEDED") {
            setTimeout(() => checkStatus(executionArn), 5000);
        }

    } catch (error) {
        logStatus(`Error fetching status: ${error.message}`);
    }
}



function displayOverlay(transaction_id) {
    logStatus("Processing complete! Displaying overlay image.");
    let overlayUrl = `https://satellite-ml-solarp-detection-data.s3.amazonaws.com/reports/${transaction_id}/overlay.png`;
    let overlayImg = document.getElementById("overlayImage");
    overlayImg.src = overlayUrl;
    overlayImg.style.display = "block";  // Ensure visibility
}



async function fetchReport(transaction_id) {
    try {
        let reportUrl = `https://satellite-ml-solarp-detection-data.s3.amazonaws.com/reports/${transaction_id}/report.html`;

        let response = await fetch(reportUrl);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        let reportHtml = await response.text();

        // Parse the HTML and extract the correct table
        let parser = new DOMParser();
        let doc = parser.parseFromString(reportHtml, "text/html");
        let tables = doc.getElementsByTagName("table");

        if (tables.length > 0) {
            let statisticsTable = tables[0];  // Assuming the first table is the statistics table
            document.getElementById("statisticsContainer").innerHTML = "<h3>Statistics</h3>" + statisticsTable.outerHTML;

            // Add the download button after displaying statistics
            document.getElementById("downloadContainer").innerHTML = `
                <button onclick="downloadResults('${transaction_id}')">Download Results</button>
            `;
        } else {
            document.getElementById("statisticsContainer").innerHTML = "<p style='color:red;'>Error: No statistics table found in the report.</p>";
        }
    } catch (error) {
        document.getElementById("statisticsContainer").innerHTML = `<p style='color:red;'>Error fetching statistics: ${error.message}</p>`;
    }
}



// Function to trigger the download
async function downloadResults(transaction_id) {
    try {
        let response = await fetch(`https://j4zkohkobg.execute-api.us-east-1.amazonaws.com/dev/download-results?transaction_id=${transaction_id}`, {
            method: "GET",
            headers: { "Content-Type": "application/json" }
        });

        let data = await response.json();
        if (data.download_url) {
            // Automatically trigger the download
            window.location.href = data.download_url;
        } else {
            alert("Error: Unable to generate download link.");
        }
    } catch (error) {
        alert("Error fetching download link: " + error.message);
    }
}



function logStatus(message) {
    let logDiv = document.getElementById("log-container");
    let p = document.createElement("p");
    p.innerText = new Date().toLocaleTimeString() + " - " + message;
    logDiv.appendChild(p);
    logDiv.scrollTop = logDiv.scrollHeight;  // Auto-scroll
}

 
    function logStatus(message) {
        let logDiv = document.getElementById("log-container");
        let logEntry = document.createElement("p");
        logEntry.innerText = `${new Date().toLocaleTimeString()} - ${message}`;
        logDiv.appendChild(logEntry);
        logDiv.scrollTop = logDiv.scrollHeight;
    }
</script>

</head>
<body>
<div class="container">
    <h2>Solar Plant Detection through Satellite Imagery (Sentinel-2)</h2>
    <div class="form-box">
        <h3>Zone of Detection</h3>
        <div class="row">
            <div class="col">
                <label>Latitude:</label>
                <input type="text" id="latitude" placeholder="Ex: -15.885858">
            </div>
            <div class="col">
                <label>Longitude:</label>
                <input type="text" id="longitude" placeholder="Ex: -47.725772">
            </div>
        </div>
        <label>North-South Distance (km):</label>
        <input type="number" id="ns_distance"><br>
        <label>West-East Distance (km):</label>
        <input type="number" id="we_distance"><br>
        <button onclick="startWorkflow()">Start Analysis</button>

        <h3>Status Logs</h3>
        <div id="log-container" class="log-box"></div>
    </div>
</div>

<style>
    .container { width: 400px; margin: auto; text-align: center; }
    .form-box { background: #f8f9fa; padding: 15px; border-radius: 8px; box-shadow: 0px 0px 5px #ccc; }
    .row { display: flex; justify-content: space-between; }
    .col { flex: 1; padding: 5px; }
    input { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; }
    button { background: #007bff; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; width: 100%; }
    button:hover { background: #0056b3; }
    .log-box { height: 150px; overflow-y: scroll; background: #e9ecef; padding: 10px; border: 1px solid #ccc; border-radius: 5px; text-align: left; }
</style>

<h3>Detection Mosaic Overlay</h3>
<img id="overlayImage" src="" alt="Overlay Image" style="max-width: 100%; height: auto; display: none;">

<div id="statisticsContainer" style="width: 100%; overflow-x: auto; border: 1px solid #ccc; padding: 10px;"></div>

<div id="downloadContainer" style="margin-top: 20px;"></div>

</body>
</html>
